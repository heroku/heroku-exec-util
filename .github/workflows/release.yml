name: Release

# This workflow is for PUBLIC repositories that need to use workflows from a PRIVATE repository
# It uses token-based checkout to access the private npm-release-workflows repository
#
# SETUP: Ensure NPM_RELEASE_WORKFLOWS_TOKEN secret is configured in repository settings

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Perform a dry run (no actual publishing)'
        required: false
        default: false
        type: boolean

jobs:
  validate:
    runs-on: pub-hk-ubuntu-24.04-ip
    steps:
      - uses: actions/checkout@v4

      - name: Checkout workflows repository
        uses: actions/checkout@v4
        with:
          repository: heroku/npm-release-workflows
          token: ${{ secrets.NPM_RELEASE_WORKFLOWS_TOKEN }}
          path: workflows-repo
          ref: main

      - name: Validate and test
        uses: ./workflows-repo/.github/actions/release-validate
        with:
          package_manager: pnpm
          lint_command: run lint
          test_command: test

  release-please-pr:
    needs: validate
    runs-on: pub-hk-ubuntu-24.04-ip
    permissions:
      contents: write
      pull-requests: write
    outputs:
      release_created: ${{ steps.release-workflow.outputs.release_created }}
      tag_name: ${{ steps.release-workflow.outputs.tag_name }}
      pr_number: ${{ steps.release-workflow.outputs.pr_number }}
      config_file: ${{ steps.release-workflow.outputs.config_file }}
      manifest_file: ${{ steps.release-workflow.outputs.manifest_file }}
      npm_tag: ${{ steps.release-workflow.outputs.npm_tag }}
      package_name: ${{ steps.release-workflow.outputs.package_name }}
      no_release_needed: ${{ steps.release-workflow.outputs.no_release_needed }}
      pr_already_exists: ${{ steps.release-workflow.outputs.pr_already_exists }}
    steps:
      - uses: actions/checkout@v4

      - name: Checkout workflows repository
        uses: actions/checkout@v4
        with:
          repository: heroku/npm-release-workflows
          token: ${{ secrets.NPM_RELEASE_WORKFLOWS_TOKEN }}
          path: workflows-repo
          ref: main

      - name: Create release PR
        id: release-workflow
        uses: ./workflows-repo/.github/actions/release-please-pr
        with:
          package_manager: pnpm
          branch_name: ${{ github.ref_name }}
          dry_run: ${{ inputs.dry_run }}

  publish:
    needs: release-please-pr
    if: needs.release-please-pr.result == 'success' && (needs.release-please-pr.outputs.pr_number != '' || needs.release-please-pr.outputs.pr_already_exists == 'true')
    runs-on: pub-hk-ubuntu-24.04-ip
    permissions:
      contents: write
      pull-requests: write
      id-token: write
    steps:
      - uses: actions/checkout@v4

      - name: Checkout workflows repository
        uses: actions/checkout@v4
        with:
          repository: heroku/npm-release-workflows
          token: ${{ secrets.NPM_RELEASE_WORKFLOWS_TOKEN }}
          path: workflows-repo
          ref: main

      - name: Publish to npm
        uses: ./workflows-repo/.github/actions/release-publish
        with:
          package_manager: pnpm
          build_command: run build
          dry_run: ${{ inputs.dry_run }}
          npm_tag: ${{ needs.release-please-pr.outputs.npm_tag }}
          package_name: ${{ needs.release-please-pr.outputs.package_name }}
          pr_number: ${{ needs.release-please-pr.outputs.pr_number }}
          branch_name: ${{ github.ref_name }}
